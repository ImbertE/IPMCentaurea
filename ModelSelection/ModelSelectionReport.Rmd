---
title: "Model Selection Report"
author: "Loïc Pages & Eric Imbert"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  word_document: default
---

First, graphical representations of raw data and the final selected model for each vital rate
Summary of each model and (quasi) explicit formula for splines

Final step : each model is renamed and a R object is created to be imported in the IPM script


Import data, models

```{r,message=FALSE}
rm(list=ls())

library(knitr)
library(spaMM)
library(tidyverse)
library(foreach)
library(doParallel)
library(splines)

### Required packages, including  `SplinesUtils` not on CRAN
if ( ! requireNamespace("SplinesUtils", quietly=TRUE)) {
  if ( ! requireNamespace("devtools", quietly=TRUE)) install.packages("devtools")
  devtools::install_github("ZheyuanLi/SplinesUtils")
}

#setpath and #getdefSplinesAsPoly
pwd <- paste0(getwd(),"/")
source(paste0(pwd, "SplinesAsPolySpaMM.R"))

IPM_data <- read.csv("../data/donneesIPM.csv")
centauree_data <- IPM_data[!is.na(IPM_data$Size0Mars) & !is.na(IPM_data$Age),]
centauree_data$Age[centauree_data$Age > 8] <- 8

load("SelectedModels.RData")
spaMM.options(separation_max=70)
```

```{r,include=FALSE}
annees <- 1995:2022
populations <- c("E2","E1","Au","Po","Pe","Cr")

taille_range <- seq(0.5, 25, by = 0.5) 
age_range <- 1:8

fake_data <- expand.grid(
  year = annees,
  Pop = populations,
  Size0Mars = taille_range,
  Age = age_range
)

fake_data <- fake_data %>% 
  mutate(Individu = row_number()) 

fake_data1 <- fake_data[fake_data$Age==1,]
fake_data2 <- fake_data[fake_data$Age>1,]
fake_data3 <- expand.grid(
  year = annees,
  Pop = populations,
  Size0Mars = taille_range,
  Age = age_range,
  Size1 = taille_range)

fake_dataEstb <- expand.grid(
  year = annees,
  Pop = populations,
  Capitule = 1:200
  )
```

Survival Probability

```{r,echo=FALSE,warning=FALSE,out.width="50%"}
survdata <- centauree_data[centauree_data$Flowering!=1 ,]

survdata %>%
  group_by(Size0Mars) %>%
  mutate(survivalProba = sum(Survie, na.rm = TRUE) / n()) %>% 
  ggplot(aes(x = Size0Mars, y = Survie)) +
  geom_count(alpha = 0.6) +  # Points dimensionnés selon la fréquence
  geom_point(aes(y = survivalProba), color = "red", size = 0.5) +
  geom_line(aes(y = survivalProba), color = "red") +
  labs(title = "Relationship between size and survival",
       x = "Size",
       y = "Survival",
       subtitle = "Grey points : observed survival (0/1)
Red points : mean value for each size") +
  ylim(0, 1) +
  theme_minimal()

survdata %>%
  group_by(Age) %>%
  mutate(survivalProba = sum(Survie, na.rm = TRUE) / n()) %>%
  ggplot(aes(x = Age, y = Survie)) +
  geom_count(alpha = 0.6) +  # Points dimensionnés selon la fréquence
  geom_point(aes(x = Age, y = survivalProba), color = "red", size = 1) +
  geom_line(aes(x = Age, y = survivalProba), color = "red") +
  labs(title = "Relationship between age and survival",
       x = "age",
       y = "Survival",
       subtitle = "Grey points : observed survival (0/1)
Red points : mean value for each age") +
  ylim(0, 1) +
  theme_minimal()
```


Seedling survival
Selected model for seedling survival Seedling_survAIC[[1]]

```{r,echo=FALSE,warning=FALSE,out.width="50%"}
survdata1 <- survdata[survdata$Age==1,]

result <- function(combi) {
  effect_formula <- paste(unlist(combi), collapse = "+")
  formula <- as.formula(paste("Survie", "~", effect_formula))
  fit <- fitme(formula, survdata1, family=binomial, method = "PQL/L")
}

Seedling_surv <- result(Seedling_survmodAIC[[1]])
summary(Seedling_surv)
SplinesAsPolySpaMM(Seedling_surv, "bs(Size0Mars, df = 4, degree = 2)")

Seedling_survpredict <- predict(Seedling_surv, survdata1, type="response")

survdata1 %>%
  mutate(predict = Seedling_survpredict) %>%
  group_by(Size0Mars) %>%
  mutate(survivalProba = sum(Survie, na.rm = TRUE) / n(), predict=mean(predict)) %>% 
  ggplot(aes(x = Size0Mars, y = Survie)) +
  geom_count(alpha = 0.6) +  # Points dimensionnés selon la fréquence
  geom_point(aes(y = survivalProba), color = "red", size = 0.5) +
  geom_line(aes(y = survivalProba), color = "red") +
  geom_line(aes(y=predict), color="green") +
     labs(title = "Relationship between size and survival",
       x = "Size",
       y = "Survival",
       subtitle = "Grey points : observed survival (0/1)
Red line : mean value for each size
Green line : predicted value") +
  ylim(0, 1) +
  theme_minimal()
```





Age > 1
Selected model for plant survival Plant_survAIC[[2]]
```{r,echo=FALSE, out.width="50%",warning=FALSE}
survdata2 <- survdata[survdata$Age>1,]

result <- function(combi) {
  effect_formula <- paste(unlist(combi), collapse = "+")
  formula <- as.formula(paste("Survie", "~", effect_formula))
  fit <- fitme(formula, survdata2, family=binomial, method = "PQL/L")
}

Plant_surv <- result(Plant_survmodAIC[[2]])
summary(Plant_surv)
SplinesAsPolySpaMM(Plant_surv,"bs(Age, degree = 3, knots = 6.5)")
SplinesAsPolySpaMM(Plant_surv,"bs(Size0Mars, df = 3, degree = 2)")

Plant_survpredict <- predict(Plant_surv, survdata2, type="response")

survdata2 %>%
  mutate(predict = Plant_survpredict) %>%
  group_by(Size0Mars) %>%
  mutate(survivalProba = sum(Survie, na.rm = TRUE) / n(), predict=mean(predict)) %>% 
  ggplot(aes(x = Size0Mars, y = Survie)) +
  geom_count(alpha = 0.6) +  # Points dimensionnés selon la fréquence
  geom_point(aes(y = survivalProba), color = "red", size = 0.5) +
  geom_line(aes(y = survivalProba), color = "red") +
  geom_line(aes(y=predict), color="green") +
  labs(title = "Relationship between size and survival",
       x = "Size",
       y = "Survival",
       subtitle = "Grey points : observed survival (0/1)
Red line : mean value for each size
Green line : predicted value for each size") +
  ylim(0, 1) +
  theme_minimal()
  
survdata2 %>%
  mutate(predict = Plant_survpredict) %>%
  group_by(Age) %>%
  mutate(survivalProba = sum(Survie, na.rm = TRUE) / n(), predict=mean(predict)) %>% 
  ggplot(aes(x = Age, y = Survie)) +
  geom_count(alpha = 0.6) +  # Points dimensionnés selon la fréquence
  geom_point(aes(y = survivalProba), color = "red", size = 0.5) +
  geom_line(aes(y = survivalProba), color = "red") +
  geom_line(aes(y=predict), color="green") +
 labs(title = "Relationship between age and survival",
       x = "Age",
       y = "Survival",
       subtitle = "Grey points : observed survival (0/1)
Red line : mean value for each age
Green line : predicted value for each age") +
  ylim(0, 1) +
  theme_minimal()
```


Growth
Selected model Growthglm1

```{r}
growthdata <- centauree_data[!is.na(centauree_data$Size1Mars), ]
growthdata <- growthdata[growthdata$Size1Mars != 0, ]
Growthpredict <- predict(Growthglm1, newdata = growthdata)[,1]
Growthpredict <- exp(log(Growthpredict)/0.4343354) #back transformation 


growthdata %>%
  mutate(predicted_value = Growthpredict) %>%
  ggplot(aes(y = Size1Mars, x = Size0Mars)) +
  geom_count(alpha=0.5) +
  geom_point(aes(y=predicted_value), col="green") +
  labs(title = "Relation entre le taux de croissance et la taille",
       y = "Taille à t+1",
       x = "Taille à t",
     subtitle = "Grey points : observed survival (0/1)
   Green points : predicted values") +
  theme_minimal()

```


Flowering Probability
Selected model flowmodAIC[[1]]

```{r,echo=FALSE,out.width="50%"}

result <- function(combi) {
  effect_formula <- paste(unlist(combi), collapse = "+")
  formula <- as.formula(paste("Flowering", "~", effect_formula))
  fit <- fitme(formula, centauree_data, family=binomial, method = "PQL/L")
}

Flowglm <- result(flowmodAIC[[1]])
summary(Flowglm)
Flowpredict <- predict(Flowglm, newdata = centauree_data)[,1]

centauree_data %>%
  mutate(predicted_value = Flowpredict) %>%
  group_by(Size0Mars) %>%
  mutate(floweringProba = sum(Flowering, na.rm = TRUE) / n(), predict=mean(predicted_value)) %>%   ggplot(aes(x = Size0Mars, y = Flowering)) +
  geom_count(alpha = 0.6) +  
  geom_point(aes(y = floweringProba), color = "red", size = 0.5) +
  geom_line(aes(y = floweringProba), color = "red") +
  geom_line(aes(y=predict), col="green") +
  labs(title = "Relationship between flowering probability and size",
    x = "Size (cm)",
    y = "Flowering",
    subtitle = "Grey points : observed reproduction (0/1)
Red points : mean value for each size
Green line : predicted value") +
  ylim(0, 1) +
  theme_minimal()

centauree_data %>%
  mutate(predicted_value = Flowpredict) %>%
  group_by(Age) %>%
  mutate(floweringProba = sum(Flowering, na.rm = TRUE) / n(), predict=mean(predicted_value)) %>%   ggplot(aes(x = Age, y = Flowering)) +
  geom_count(alpha = 0.6) +  
  geom_point(aes(y = floweringProba), color = "red", size = 0.5) +
  geom_line(aes(y = floweringProba), color = "red") +
  geom_line(aes(y = predict), color = "green") +
    labs(title = "Relationship between flowering probability and age",
    x = "Age",
    y = "Flowering",
    subtitle = "Grey points : observed reproduction (0/1)
Red points : mean value for each age
Green line : predicted value") +
  ylim(0, 1) +
  theme_minimal()




```



Fecundity

```{r,echo=FALSE,out.width="50%",warning=FALSE}

cptl_data <- centauree_data[centauree_data$Flowering==1,]
cptl_data <- cptl_data[!is.na(cptl_data$Capitule),]

summary(Cptlglm1)
Cptlpredict <- predict(Cptlglm1, newdata = cptl_data)[,1]
Cptlpredict <- exp(Cptlpredict) #back transformation


# Nombre de capitules / taille 
cptl_data %>%
  mutate(predicted_value = Cptlpredict) %>%
  ggplot(aes(x = Size0Mars, y = Capitule)) +
  geom_point(col="red") +
  geom_point(aes(y=predicted_value), col="green") +
  labs(title = "Relation entre la taille et le nombre de capitules",
       y = "Nbre de capitules",
       x = "Size (cm)",
     subtitle = "Red points : observed values
   Green points : predicted values") +
  theme_minimal()


#Nbr de capitules / Year
cptl_data %>%
  mutate(predicted_value = Cptlpredict) %>%
  group_by(year) %>%
  mutate(Observed = mean(Capitule, na.rm = TRUE), predict=mean(predicted_value)) %>%
  ggplot(aes(x = year, y = Observed)) +
  geom_point(aes(y = Observed), color = "red", size = 0.5) +
  geom_line(aes(y = Observed), color = "red") +
  geom_line(aes(y = predict), color = "green") +
  labs(title = "Relationship between fecundity and year",
    x = "Year",
    y = "Nb of seed heads",
    subtitle = 
      "Red points : mean value for each year
      Green line : predicted value") +
  theme_minimal()
```




Seedling Size 
```{r,echo=FALSE,out.width="50%"}
plantule_data <- centauree_data[centauree_data$Age==1,]

effect_formula <- paste(unlist(pltmodAIC[[1]]), collapse = "+")
formula <- as.formula(paste("Size0Mars", "~", effect_formula))
Pltglm <- fitme(formula, data = plantule_data, family=Gamma(log), method = "PQL/L")
summary(Pltglm)
Pltpredict <- predict(Pltglm, newdata = plantule_data, type=("response"))[,1]


# Seedling size distribution
#Mean value per year
plantule_data %>%
  mutate(predicted_value=Pltpredict) %>%
  group_by(year) %>%
  mutate(ObsSize = mean(Size0Mars), PredSize=mean(predicted_value)) %>%
  ggplot(aes(x = year, y = ObsSize)) +
  geom_count(alpha = 0.6) +  
  geom_point(aes(y = ObsSize), color = "red", size = 0.5) +
  geom_line(aes(y = ObsSize), color = "red") +
  geom_line(aes(y =PredSize), color = "green") +
  labs(title = "Mean seedling per year",
    x = "Year",
    y = "Size (cm)",
subtitle = "Red points : mean value for each year
Green line : predicted value") +
  theme_minimal()
  
# Seedling size distribution
mydata1 <- data.frame(tapply(plantule_data$Size0Mars, plantule_data$Pop,mean),
                     tapply(plantule_data$Size0Mars, plantule_data$Pop,sd))
mydata1$Pop <- row.names(mydata1)
mydata1$Val <- "Obs"
mydata2 <- data.frame(tapply(Pltpredict, plantule_data$Pop,mean),
                     tapply(Pltpredict, plantule_data$Pop,sd))
mydata2$Pop <- row.names(mydata2)
mydata2$Val <- "Pred"

names(mydata1) <- names(mydata2) <- c("Mean","Sd","Pop","Type")
mydata <- rbind(mydata1, mydata2)

ggplot(mydata, aes(x = Pop, y = Mean, fill=Type)) +
      geom_bar(stat="identity", position="dodge") +
      geom_errorbar(aes(ymin = Mean-Sd, ymax = Mean+Sd), width=.2,
                    position=position_dodge(.9))
  labs(title = "Mean seedling size (and SD) per population",
    x = "Population",
    y = "Size (cm)",
subtitle = "Obs. : mean of observed values
Pred. : predicted value") +
  theme_minimal()


```



Establishement rate


```{r}
#First replace NA values for number of capitula using predicted values from selected model
cptldata_predi <- IPM_data[IPM_data$Flowering==1,] %>%
  mutate(Capitule = ifelse(is.na(Capitule),exp(predict(Cptlglm1)),Capitule))

#Number of seedlings
plt <- IPM_data %>% 
  filter(Age==1) %>% 
  group_by(Quadrat,year,Pop) %>% 
  summarize(NombrePlantules = sum(Age))

cptl <- cptldata_predi %>% 
  group_by(Quadrat,year,Pop) %>% 
  summarize(Capitule = sum(Capitule))
cptl$year <- cptl$year+1

Estb <- inner_join(plt,cptl, by=join_by(Quadrat,year,Pop))
Estb$ratio <- Estb$NombrePlantules/Estb$Capitule
```

Number of seedlings observed is dependent on the number of seed heads :
```{r}
Estbglm <- fitme(NombrePlantules ~ 1 + offset(log(Capitule)) + (1|Pop:year),data = Estb,
                  family = Poisson(log))

Estb$pred <- predict(Estbglm, Estb)[,1]
Estb$predratio <- Estb$pred/Estb$Capitule
```


Observed and predicted Values per year
```{r}
Estb %>%
  group_by(year) %>%
  summarise(meanratio = mean(ratio), meanpredratio = mean(predratio)) %>%
  ggplot(aes(x = year, y = meanratio)) +
  geom_line(col="red") +
  geom_line(aes(y=meanpredratio), col="green") +
  labs(y="Establishment rate",
       x="Year",
       subtitle = "Red line : mean of observed values
       Green line : predicted value") +
    theme_minimal()

```
Final name of each model and save to a final object to be imported in the IPM script

```{r}

Seedling_surv
Plant_surv
Growth <- Growthglm1
Flowering <- Flowglm
Fecundity <- Cptlglm1
Seedling_size <- Pltglm
Estbrate <- Estbglm

save(Seedling_surv,Plant_surv,Growth,Flowering,Fecundity,Seedling_size,Estbrate,
     file="../IPM/VitalRates.RData")
```

